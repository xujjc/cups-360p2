name: Build OpenWrt for 360P2 Printer Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openwrtorg/sdk:21.02-snapshot  # 使用官方SDK镜像加速编译

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4

    - name: 初始化编译环境
      run: |
        # 安装编译依赖
        apt update
        apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib git gettext libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

        # 下载OpenWrt源码（21.02 LTS版）
        git clone -b openwrt-21.02 https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt

    - name: 配置目标设备
      run: |
        cd openwrt
        # 配置360P2目标
        make menuconfig <<EOF
        TARGET_DEVICE_360P2=y
        EOF

    - name: 应用自定义配置
      run: |
        cd openwrt
        # 写入完整配置（包含中文支持、打印机驱动等）
        cat <<CONFIG > .config
        CONFIG_TARGET_ramips=y
        CONFIG_TARGET_ramips_mt7628=y
        CONFIG_TARGET_ramips_mt7628_DEVICE_360p2=y

        # 中文界面
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

        # 打印机服务
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_cups-daemon=y
        CONFIG_PACKAGE_cups-filters=y
        CONFIG_PACKAGE_cups-zh-cn=y
        CONFIG_PACKAGE_avahi=y
        CONFIG_PACKAGE_avahi-daemon=y
        CONFIG_PACKAGE_gutenprint=y
        CONFIG_PACKAGE_usb-printer=y
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        CONFIG_PACKAGE_kmod-usb-uhci=y
        CONFIG_PACKAGE_kmod-usb-storage=y

        # 网络功能
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-dwc2=y
        CONFIG_PACKAGE_kmod-usb-ledtrig-usbport=y

        # 闪存优化（16MB）
        CONFIG_TARGET_ROOTFS_PARTSIZE=14
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_ROOTFS_CPIOGZ=n
        CONFIG_TARGET_ROOTFS_SQUASHFS=n
        CONFIG_TARGET_KERNEL_PARTSIZE=2
        CONFIG_TARGET_OVERLAY_SIZE=4096
        CONFIG_TARGET_KERNEL_PARTITION=y
        CONFIG_TARGET_ROOTFS_TRIMMING=y
        CONFIG_TARGET_PER_DEVICE_ROOTFS=y
        CONFIG_TARGET_INITRAMFS_COMPRESSION="gzip"
        CONFIG_TARGET_ROOTFS_INITRAMFS=n
        CONFIG_TARGET_ROOTFS_JFFS2=n
        CONFIG_TARGET_ROOTFS_UBIFS=n
        CONFIG_TARGET_ROOTFS_TRIMMING=y
        CONFIG_TARGET_ROOTFS_CPIOGZ=n
        CONFIG_TARGET_ROOTFS_SQUASHFS=n
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_ROOTFS_EXT4FS_OPTIONS="-b 4096 -O ^metadata_csum,^64bit"
        CONFIG_TARGET_ROOTFS_PARTSIZE=14
        CONFIG_TARGET_KERNEL_PARTSIZE=2
        CONFIG_TARGET_OVERLAY_SIZE=4096
        CONFIG_TARGET_ROOTFS_TRIMMING=y
        CONFIG_TARGET_PER_DEVICE_ROOTFS=y
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_ROOTFS_EXT4FS_OPTIONS="-b 4096 -O ^metadata_csum,^64bit"
        EOF

    - name: 下载依赖包
      run: |
        cd openwrt
        make download -j8

    - name: 编译固件
      run: |
        cd openwrt
        make -j$(nproc) V=s  # 使用多核加速编译

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-360p2-printer
        path: openwrt/bin/targets/ramips/mt7628/openwrt-*-ramips-mt7628-360p2-squashfs-sysupgrade.bin
