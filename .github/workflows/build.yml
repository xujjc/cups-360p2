name: Build OpenWrt for 360P2 Printer

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python3 unzip wget \
        python3-venv python3-setuptools rsync subversion swig time \
        xsltproc zlib1g-dev

        # 安装 distutils 的替代方案
        sudo apt-get install -y python3-distutils-extra || echo "使用内置distutils"
        python3 -c "import distutils; print('distutils available')"

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git --depth=1 --branch openwrt-22.03.5
        cd openwrt

    - name: Configure build
      run: |
        cd openwrt
        cat > .config << EOF
        CONFIG_TARGET_ramips=y
        CONFIG_TARGET_ramips_mt76x8=y
        CONFIG_TARGET_ramips_mt76x8_DEVICE_360_p2=y

        # 中文支持
        CONFIG_PACKAGE_luci=y
        CONFIG_LUCI_LANG_zh-cn=y
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

        # CUPS 打印机服务器
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_cups-filters=y
        CONFIG_PACKAGE_luci-app-cups=y
        CONFIG_PACKAGE_luci-i18n-cups-zh-cn=y

        # 打印机驱动 (佳能 MF4452)
        CONFIG_PACKAGE_gutenprint=y
        CONFIG_PACKAGE_gutenprint-ppds=y
        CONFIG_PACKAGE_kmod-usb-printer=y

        # Avahi 零配置网络
        CONFIG_PACKAGE_avahi-daemon-service-http=y
        CONFIG_PACKAGE_avahi-daemon-service-ipp=y
        CONFIG_PACKAGE_avahi-nodbus-daemon=y
        CONFIG_PACKAGE_libavahi-client=y

        # 网络基础功能
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_iptables-mod-extra=y

        # 空间优化 (16MB 闪存)
        CONFIG_PACKAGE_luci-app-upnp=n
        CONFIG_PACKAGE_luci-app-ddns=n
        CONFIG_PACKAGE_ppp=n
        CONFIG_PACKAGE_ppp-mod-pppoe=n
        CONFIG_PACKAGE_luci-app-firewall=n
        EOF

        # 安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-360p2-printer
        path: openwrt/bin/targets/ramips/mt76x8/
