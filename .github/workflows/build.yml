name: 360P2 Printer Firmware Builder

on:
  workflow_dispatch:
    inputs:
      printer_ip:
        description: 'Printer IP Address (e.g., 192.168.1.100)'
        required: true
        default: '192.168.2.1'
      web_admin_user:
        description: 'Web Admin Username'
        required: true
        default: 'admin'
      web_admin_pass:
        description: 'Web Admin Password'
        required: true
        default: 'admin'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev gawk git gettext \
        subversion mercurial cmake python3-distutils rsync unzip
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
    - name: ðŸ§¹ Clean Disk Space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc
        sudo rm -rf /usr/local/lib/node_modules /usr/lib/node_modules
        sudo rm -rf /usr/share/swift /usr/local/bin/ /usr/share/rust
        df -h

    - name: ðŸ“‚ Clone OpenWrt Source
      run: |
        git clone --depth 1 https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt
        git fetch --tags
        git checkout v23.05.2  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬

    - name: âš™ï¸ Configure Firmware
      run: |
        cd openwrt
        
        # åˆ›å»ºå¹²å‡€çš„.configæ–‡ä»¶
        cat > .config << 'EOF'
        # ç¡¬ä»¶é…ç½®
        CONFIG_TARGET_ramips=y
        CONFIG_TARGET_ramips_mt76x8=y
        CONFIG_TARGET_ramips_mt7628_DEVICE_360p2=y
        # å¢žåŠ åˆ†åŒºå¤§å°
        CONFIG_TARGET_ROOTFS_PARTSIZE=16
        
        # æ ¸å¿ƒç½‘ç»œåŠŸèƒ½
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_firewall=y
        CONFIG_PACKAGE_opkg=y
        CONFIG_PACKAGE_wpad-basic-wolfssl=y
        
        # æ‰“å°æœåŠ¡é…ç½®
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_cups-filters=y
        CONFIG_PACKAGE_cups-bjnp=y
        CONFIG_PACKAGE_cups-www=y
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_libjpeg=y
        CONFIG_PACKAGE_libpng=y
        
        # ç¦ç”¨ä¸å¿…è¦ç»„ä»¶
        CONFIG_PACKAGE_cups-ppdc=n
        CONFIG_PACKAGE_ghostscript=n
        CONFIG_PACKAGE_gutenprint=n
        CONFIG_PACKAGE_foomatic-filters=n
        
        # Webç•Œé¢å¢žå¼º
        CONFIG_PACKAGE_luci-base=y  # ä»…å®‰è£…åŸºç¡€LUCI
        CONFIG_PACKAGE_luci-app-cups=y
                
        # ç³»ç»ŸåŸºç¡€ç»„ä»¶
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_PACKAGE_wireless-regdb=y
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_block-mount=y
        CONFIG_PACKAGE_fdisk=y
        
        # ç¦ç”¨å†²çªåŒ…å’Œé—®é¢˜åŒ…
        CONFIG_PACKAGE_kmod-usb-storage=n
        CONFIG_PACKAGE_samba4-server=n
        CONFIG_PACKAGE_miniupnpd=n
        CONFIG_PACKAGE_audit=n
        CONFIG_PACKAGE_policycoreutils=n
        CONFIG_PACKAGE_lldpd=n
        CONFIG_PACKAGE_kexec-tools=n
        CONFIG_PACKAGE_python3-pymysql=n
        CONFIG_PACKAGE_python3=n  # å®Œå…¨ç¦ç”¨Python3
        CONFIG_PACKAGE_luci-app-dockerman=n
        CONFIG_PACKAGE_luci-app-adblock=n
        EOF

    - name: ðŸ–¨ï¸ Add Printer Support Files
      run: |
        cd openwrt
        
        # åˆ›å»ºç²¾ç®€PPDæ–‡ä»¶
        mkdir -p files/usr/share/cups/model/
        cat > files/usr/share/cups/model/canon-mf4452-minimal.ppd << 'EOF'
        *PPD-Adobe: "4.3"
        *FormatVersion: "4.3"
        *FileVersion: "1.0"
        *LanguageVersion: English
        *LanguageEncoding: ISOLatin1
        *PCFileName: "canon-mf4452-minimal.ppd"
        *Manufacturer: "Canon"
        *Product: "(Canon MF4452)"
        *ModelName: "Canon MF4452 Minimal"
        *ShortNickName: "Canon MF4452"
        *NickName: "Canon MF4452 Minimal Driver"
        *PSVersion: "(3010.000) 0"
        
        *OpenUI *PageSize/Page Size: PickOne
        *DefaultPageSize: A4
        *PageSize Letter/Letter:  "<</PageSize[612 792]>>setpagedevice"
        *PageSize A4/A4:          "<</PageSize[595 842]>>setpagedevice"
        
        *OpenUI *Resolution/Resolution: PickOne
        *DefaultResolution: 600dpi
        *Resolution 600dpi/600 DPI:  "<</HWResolution[600 600]>>setpagedevice"
        
        *OpenUI *ColorModel/Color Mode: PickOne
        *DefaultColorModel: Gray
        *ColorModel Gray/Grayscale: "<</cupsColorSpace 0/cupsColorOrder 0>>"
        
        *OpenUI *InputSlot/Paper Source: PickOne
        *DefaultInputSlot: Auto
        *InputSlot Auto/Automatic: "<</ManualFeed false>>"
        *InputSlot Tray1/Tray 1: "<</MediaPosition 1>>"
        
        *cupsFilter: "application/vnd.cups-postscript 0 -"
        EOF
        
        # åˆ›å»ºæ‰“å°æœºè‡ªåŠ¨é…ç½®è„šæœ¬
        mkdir -p files/etc/uci-defaults/
        cat > files/etc/uci-defaults/99-setup-printer << 'EOF'
        #!/bin/sh
        
        # ç­‰å¾…ç½‘ç»œå°±ç»ª
        sleep 15
        
        # è®¾ç½®æ‰“å°æœº
        lpadmin -p Canon_MF4452 \
          -E \
          -v "bjnp://$PRINTER_IP" \
          -m /usr/share/cups/model/canon-mf4452-minimal.ppd
        
        # è®¾ä¸ºé»˜è®¤æ‰“å°æœº
        lpoptions -d Canon_MF4452
        
        # åˆ›å»ºCUPSç®¡ç†å‘˜è´¦æˆ·
        echo "$WEB_ADMIN_USER:$(openssl passwd -6 '$WEB_ADMIN_PASS')" > /etc/cups/passwd.md5
        chmod 600 /etc/cups/passwd.md5
        
        # å¯åŠ¨æœåŠ¡
        /etc/init.d/cups enable
        /etc/init.d/cups start
        
        # é…ç½®é˜²ç«å¢™å…è®¸CUPSè®¿é—®
        uci add firewall rule
        uci set firewall.@rule[-1].name='Allow-CUPS-Web'
        uci set firewall.@rule[-1].src='lan'
        uci set firewall.@rule[-1].proto='tcp'
        uci set firewall.@rule[-1].dest_port='631'
        uci set firewall.@rule[-1].target='ACCEPT'
        uci commit firewall
        
        # ä»…è¿è¡Œä¸€æ¬¡
        rm -f /etc/uci-defaults/99-setup-printer
        exit 0
        EOF
        chmod +x files/etc/uci-defaults/99-setup-printer
        
        # CUPS Webç•Œé¢é…ç½®
        mkdir -p files/etc/cups/
        cat > files/etc/cups/cupsd.conf << 'EOF'
        LogLevel warn
        MaxLogSize 0
        Listen 0.0.0.0:631
        Browsing On
        BrowseLocalProtocols dnssd
        DefaultAuthType Basic
        
        # Webç®¡ç†ç•Œé¢é…ç½®
        WebInterface Yes
        
        # è®¿é—®æŽ§åˆ¶
        <Location />
          Order allow,deny
          Allow 192.168.0.0/16
        </Location>
        
        <Location /admin>
          Order allow,deny
          Allow 192.168.0.0/16
          AuthType Basic
          AuthClass System
          AuthGroupName system
          Require user @SYSTEM @ADMIN
        </Location>
        
        <Location /admin/conf>
          AuthType Basic
          AuthClass System
          AuthGroupName system
          Require user @SYSTEM @ADMIN
          Order allow,deny
          Allow 192.168.0.0/16
        </Location>
        
        <Policy admin>
          Require user @SYSTEM @ADMIN
        </Policy>
        
          Require user @OWNER @SYSTEM
        </Policy>
        EOF
        
        # åˆ›å»ºCUPSç®¡ç†å‘˜ç»„
        cat > files/etc/cups/cups-files.conf << 'EOF'
        SystemGroup root
        EOF

    - name: ðŸ”§ Fix Recursive Dependencies
      run: |
        cd openwrt
        # å½»åº•åˆ é™¤é—®é¢˜åŒ…åŠå…¶ä¾èµ–
        sed -i '/CONFIG_PACKAGE_python3-pymysql/d' .config
        sed -i '/CONFIG_PYTHON3_PYMYSQL_SHA_PASSWORD_SUPPORT/d' .config
        
        # å®Œå…¨ç¦ç”¨Python3
        echo "CONFIG_PACKAGE_python3=n" >> .config
        echo "CONFIG_PACKAGE_python3-base=n" >> .config
        
        # å¼ºåˆ¶å¯ç”¨CUPS
        echo "CONFIG_PACKAGE_cups=y" >> .config
        echo "CONFIG_PACKAGE_cups-www=y" >> .config

    - name: ðŸ”„ Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        
        # ä»…å®‰è£…å¿…è¦åŒ…ï¼Œé¿å…è§¦å‘ä¾èµ–é—®é¢˜
        ./scripts/feeds install -a -d y -p packages cups cups-www
        ./scripts/feeds install -a -d y -p luci luci-app-cups
        ./scripts/feeds install -a -d y libcups libusb

    - name: ðŸ” Validate Config
      run: |
        cd openwrt
        # æ¸…ç†æ— æ•ˆä¾èµ–è­¦å‘Š
        sed -i '/^WARNING:/d' .config || true
        
        # ä¿®å¤æ ¼å¼é—®é¢˜
        sed -i 's/  #.*//' .config || true
        
        # ç¡®ä¿å…³é”®é…ç½®å­˜åœ¨
        echo "CONFIG_PACKAGE_cups=y" >> .config
        echo "CONFIG_PACKAGE_cups-www=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7628_DEVICE_360p2=y" >> .config
        
        # æ˜¾ç¤ºå½“å‰é…ç½®
        echo "=== Current Configuration ==="
        cat .config | grep -v "^#" | grep -v "^$"
        
        # è¿è¡Œdefconfig
        make defconfig
        
        # éªŒè¯å…³é”®é…ç½®
        if ! grep -q "CONFIG_PACKAGE_cups=y" .config; then
          echo "::error::CUPS not enabled"
          exit 1
        fi
        if ! grep -q "CONFIG_PACKAGE_cups-www=y" .config; then
          echo "::error::CUPS Web not enabled"
          exit 1
        fi
        if ! grep -q "CONFIG_TARGET_ramips_mt7628_DEVICE_360p2=y" .config; then
          echo "::error::Device not set to 360p2"
          exit 1
        fi
        
        echo "=== Key Configurations ==="
        grep "CONFIG_TARGET" .config | grep -v "=n"
        grep "CONFIG_PACKAGE_cups" .config

    - name: ðŸ› ï¸ Compile Firmware
      run: |
        cd openwrt
        export FORCE_UNSAFE_CONFIGURE=1
        
        # ä¿®å¤ä¸‹è½½é—®é¢˜
        make download -j8
        
        # å¹¶è¡Œç¼–è¯‘ä½†é™åˆ¶èµ„æºä½¿ç”¨
        make -j$(($(nproc)/2)) V=s
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        if [ ! -d bin/targets/ramips/mt76x8 ]; then
          echo "::error::Build failed - no output directory found"
          exit 1
        fi

    - name: ðŸ“¦ Package Firmware
      run: |
        cd openwrt/bin/targets/ramips/mt76x8
        FIRMWARE_FILE=$(ls openwrt-ramips-mt76x8-360-p2-squashfs-sysupgrade.bin)
        echo "Firmware file: $FIRMWARE_FILE"
        echo "firmware_name=$FIRMWARE_FILE" >> $GITHUB_ENV
        
        # åˆ›å»ºWebè®¿é—®ä¿¡æ¯æ–‡ä»¶
        LAN_IP="192.168.2.1"  # é»˜è®¤è·¯ç”±å™¨IP
        echo "CUPS Web Interface: http://$LAN_IP:631" > web-access.txt
        echo "Username: ${{ github.event.inputs.web_admin_user}}" >> web-access.txt
        echo "Password: ${{ github.event.inputs.web_admin_pass}}" >> web-access.txt
        echo "Printer IP: ${{ github.event.inputs.printer_ip}}" >> web-access.txt

    - name: ðŸš€ Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: 360P2-Printer-Firmware
        path: |
          openwrt/bin/targets/ramips/mt76x8/openwrt-ramips-mt76x8-360-p2-squashfs-sysupgrade.bin
          openwrt/bin/targets/ramips/mt76x8/web-access.txt
