name: 360P2 Printer Firmware Builder with Local CUPS Build

on:
  workflow_dispatch:
    inputs:
      printer_ip:
        description: 'Printer IP Address (e.g., 192.168.1.100)'
        required: true
        default: '192.168.1.100'
      web_admin_user:
        description: 'Web Admin Username'
        required: true
        default: 'admin'
      web_admin_pass:
        description: 'Web Admin Password'
        required: true
        default: 'openwrt'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üîß Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev gawk git gettext \
        subversion mercurial cmake python3-distutils rsync unzip wget
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
    - name: üßπ Clean Disk Space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc
        sudo rm -rf /usr/local/lib/node_modules /usr/lib/node_modules
        sudo rm -rf /usr/share/swift /usr/local/bin/ /usr/share/rust
        df -h

    - name: üìÇ Clone OpenWrt Source
      run: |
        git clone --depth 1 https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt
        git fetch --tags
        git checkout v23.05.2  # ‰ΩøÁî®ÊúÄÊñ∞Á®≥ÂÆöÁâà

    - name: üõ†Ô∏è Fix Recursive Dependency
      run: |
        cd openwrt
        # ÁßªÈô§CUPSÂØπpython3-pymysqlÁöÑ‰æùËµñ
        sed -i '/select PACKAGE_python3-pymysql/d' package/feeds/packages/cups/Config.in
        sed -i '/depends on PACKAGE_python3-pymysql/d' package/feeds/packages/cups/Config.in
        
        # Âà†Èô§ÊúâÈóÆÈ¢òÁöÑpythonÂåÖ
        rm -rf feeds/packages/lang/python/pymysql
        rm -rf feeds/packages/lang/python/python3-pymysql

    - name: ‚öôÔ∏è Configure Firmware
      run: |
        cd openwrt
        
        # ÂàõÂª∫ÊúÄÂ∞èÂåñÈÖçÁΩÆ
        cat > .config << 'EOF'
        # Á°¨‰ª∂ÈÖçÁΩÆ
        CONFIG_TARGET_ramips=y
        CONFIG_TARGET_ramips_mt76x8=y
        CONFIG_TARGET_ramips_mt7628_DEVICE_360p2=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=24  # Â¢ûÂä†ÂàÜÂå∫Â§ßÂ∞è
        
        # Ê†∏ÂøÉÁΩëÁªúÂäüËÉΩ
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_firewall=y
        CONFIG_PACKAGE_opkg=y
        CONFIG_PACKAGE_wpad-basic-wolfssl=y
        
        # ÊâìÂç∞ÊúçÂä°ÈÖçÁΩÆ
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_cups-filters=y
        CONFIG_PACKAGE_cups-bjnp=y
        CONFIG_PACKAGE_cups-www=y
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_libjpeg=y
        CONFIG_PACKAGE_libpng=y
        
        # Á≥ªÁªüÂü∫Á°ÄÁªÑ‰ª∂
        CONFIG_PACKAGE_block-mount=y
        CONFIG_PACKAGE_fdisk=y
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        
        # Á¶ÅÁî®ÂÜ≤Á™ÅÂåÖ
        CONFIG_PACKAGE_kmod-usb-storage=n
        CONFIG_PACKAGE_samba4-server=n
        CONFIG_PACKAGE_miniupnpd=n
        CONFIG_PACKAGE_python3=n
        CONFIG_PACKAGE_python3-base=n
        EOF

    - name: üîÑ Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ÂÆâË£ÖÂøÖË¶ÅÁöÑÂü∫Á°ÄÂåÖ
        ./scripts/feeds install libcups libusb cups cups-www

    - name: üî® Build CUPS Packages
      run: |
        cd openwrt
        # ÂáÜÂ§áÁºñËØëÁéØÂ¢É
        make defconfig
        make tools/install
        make toolchain/install
        
        # ÂçïÁã¨ÁºñËØëCUPSÂèäÂÖ∂‰æùËµñ
        make package/libcups/compile -j$(nproc) V=s
        make package/cups/compile -j$(nproc) V=s
        make package/cups-www/compile -j$(nproc) V=s
        make package/cups-filters/compile -j$(nproc) V=s
        make package/cups-bjnp/compile -j$(nproc) V=s
        make package/kmod-usb-printer/compile -j$(nproc) V=s
        
        # ÂàõÂª∫ÂåÖÁõÆÂΩï
        mkdir -p bin/packages/mipsel_24kc/base/
        
        # Â§çÂà∂ÁºñËØëÂ•ΩÁöÑÂåÖ
        find bin/packages/ -name "cups*.ipk" -exec cp {} bin/packages/mipsel_24kc/base/ \;
        find bin/packages/ -name "libcups*.ipk" -exec cp {} bin/packages/mipsel_24kc/base/ \;
        find bin/packages/ -name "kmod-usb-printer*.ipk" -exec cp {} bin/packages/mipsel_24kc/base/ \;
        
        # ÂàõÂª∫ÂåÖÁ¥¢Âºï
        ./scripts/ipkg-make-index.sh bin/packages/mipsel_24kc/base/ > bin/packages/mipsel_24kc/base/Packages
        gzip -9c bin/packages/mipsel_24kc/base/Packages > bin/packages/mipsel_24kc/base/Packages.gz

    - name: üñ®Ô∏è Add Printer Support Files
      run: |
        cd openwrt
        
        # ÂàõÂª∫Á≤æÁÆÄPPDÊñá‰ª∂
        mkdir -p files/usr/share/cups/model/
        cat > files/usr/share/cups/model/canon-mf4452-minimal.ppd << 'EOF'
        *PPD-Adobe: "4.3"
        *FormatVersion: "4.3"
        *FileVersion: "1.0"
        *LanguageVersion: English
        *LanguageEncoding: ISOLatin1
        *PCFileName: "canon-mf4452-minimal.ppd"
        *Manufacturer: "Canon"
        *Product: "(Canon MF4452)"
        *ModelName: "Canon MF4452 Minimal"
        *ShortNickName: "Canon MF4452"
        *NickName: "Canon MF4452 Minimal Driver"
        *PSVersion: "(3010.000) 0"
        
        *OpenUI *PageSize/Page Size: PickOne
        *DefaultPageSize: A4
        *PageSize Letter/Letter:  "<</PageSize[612 792]>>setpagedevice"
        *PageSize A4/A4:          "<</PageSize[595 842]>>setpagedevice"
        
        *OpenUI *Resolution/Resolution: PickOne
        *DefaultResolution: 600dpi
        *Resolution 600dpi/600 DPI:  "<</HWResolution[600 600]>>setpagedevice"
        
        *OpenUI *ColorModel/Color Mode: PickOne
        *DefaultColorModel: Gray
        *ColorModel Gray/Grayscale: "<</cupsColorSpace 0/cupsColorOrder 0>>"
        
        *OpenUI *InputSlot/Paper Source: PickOne
        *DefaultInputSlot: Auto
        *InputSlot Auto/Automatic: "<</ManualFeed false>>"
        *InputSlot Tray1/Tray 1: "<</MediaPosition 1>>"
        
        *cupsFilter: "application/vnd.cups-postscript 0 -"
        EOF
        
        # ÂàõÂª∫ÊâìÂç∞Êú∫Ëá™Âä®ÈÖçÁΩÆËÑöÊú¨
        mkdir -p files/etc/uci-defaults/
        cat > files/etc/uci-defaults/99-setup-printer << 'EOF'
        #!/bin/sh
        
        # Á≠âÂæÖÁΩëÁªúÂ∞±Áª™
        sleep 15
        
        # ÂÆâË£ÖCUPSÂåÖ
        opkg update
        opkg install /tmp/cups-packages/*.ipk

        # ËÆæÁΩÆÊâìÂç∞Êú∫
        lpadmin -p Canon_MF4452 \
          -E \
          -v "bjnp://$PRINTER_IP" \
          -m /usr/share/cups/model/canon-mf4452-minimal.ppd
        
        # ËÆæ‰∏∫ÈªòËÆ§ÊâìÂç∞Êú∫
        lpoptions -d Canon_MF4452
        
        # ÂàõÂª∫CUPSÁÆ°ÁêÜÂëòË¥¶Êà∑
        echo "$WEB_ADMIN_USER:$(openssl passwd -6 '$WEB_ADMIN_PASS')" > /etc/cups/passwd.md5
        chmod 600 /etc/cups/passwd.md5
        
        # ÂêØÂä®ÊúçÂä°
        /etc/init.d/cups enable
        /etc/init.d/cups start
        
        # ÈÖçÁΩÆÈò≤ÁÅ´Â¢ôÂÖÅËÆ∏CUPSËÆøÈóÆ
        uci add firewall rule
        uci set firewall.@rule[-1].name='Allow-CUPS-Web'
        uci set firewall.@rule[-1].src='lan'
        uci set firewall.@rule[-1].proto='tcp'
        uci set firewall.@rule[-1].dest_port='631'
        uci set firewall.@rule[-1].target='ACCEPT'
        uci commit firewall
        
        # ‰ªÖËøêË°å‰∏ÄÊ¨°
        rm -f /etc/uci-defaults/99-setup-printer
        exit 0
        EOF
        chmod +x files/etc/uci-defaults/99-setup-printer
        
        # ÂàõÂª∫CUPSÂåÖÂ≠òÂÇ®ÁõÆÂΩï
        mkdir -p files/tmp/cups-packages/
        
        # Â§çÂà∂ÁºñËØëÂ•ΩÁöÑÂåÖÂà∞Âõ∫‰ª∂‰∏≠
        cp bin/packages/mipsel_24kc/base/*.ipk files/tmp/cups-packages/
        
        # CUPS WebÁïåÈù¢ÈÖçÁΩÆ
        mkdir -p files/etc/cups/
        cat > files/etc/cups/cupsd.conf << 'EOF'
        LogLevel warn
        MaxLogSize 0
        Listen 0.0.0.0:631
        Browsing On
        BrowseLocalProtocols dnssd
        DefaultAuthType Basic
        
        # WebÁÆ°ÁêÜÁïåÈù¢ÈÖçÁΩÆ
        WebInterface Yes
        
        # ËÆøÈóÆÊéßÂà∂
        <Location />
          Order allow,deny
          Allow 192.168.0.0/16
        </Location>
        
        <Location /admin>
          Order allow,deny
          Allow 192.168.0.0/16
          AuthType Basic
          AuthClass System
          AuthGroupName system
          Require user @SYSTEM @ADMIN
        </Location>
        
        <Policy admin>
          Require user @SYSTEM @ADMIN
        </Policy>
        EOF
        
        # ÂàõÂª∫CUPSÁÆ°ÁêÜÂëòÁªÑ
        cat > files/etc/cups/cups-files.conf << 'EOF'
        SystemGroup root
        EOF

    - name: üîß Finalize Config
      run: |
        cd openwrt
        # Á¶ÅÁî®CUPSÁºñËØëÔºàÂõ†‰∏∫Êàë‰ª¨Â∑≤ÁªèÈ¢ÑÁºñËØë‰∫ÜÔºâ
        sed -i 's/CONFIG_PACKAGE_cups=y/CONFIG_PACKAGE_cups=n/' .config
        sed -i 's/CONFIG_PACKAGE_cups-www=y/CONFIG_PACKAGE_cups-www/n/' .config
        sed -i 's/CONFIG_PACKAGE_cups-filters=y/CONFIG_PACKAGE_cups-filters=n/' .config
        sed -i 's/CONFIG_PACKAGE_cups-bjnp=y/CONFIG_PACKAGE_cups-bjnp=n/' .config
        sed -i 's/CONFIG_PACKAGE_kmod-usb-printer=y/CONFIG_PACKAGE_kmod-usb-printer=n/' .config
        
        # Á°Æ‰øùÈÖçÁΩÆÊ≠£Á°Æ
        make defconfig

    - name: üõ†Ô∏è Compile Firmware
      run: |
        cd openwrt
        export FORCE_UNSAFE_CONFIGURE=1
        
        # ‰øÆÂ§ç‰∏ãËΩΩÈóÆÈ¢ò
        make download -j$(nproc)
        
        # Âπ∂Ë°åÁºñËØë
        make -j$(($(nproc) + 1)) V=s
        
        # Ê£ÄÊü•ÊûÑÂª∫ÁªìÊûú
        if [ ! -d bin/targets/ramips/mt76x8 ]; then
          echo "::error::Build failed - no output directory found"
          exit 1
        fi

    - name: üì¶ Package Firmware
      run: |
        cd openwrt/bin/targets/ramips/mt76x8
        FIRMWARE_FILE=$(ls openwrt-ramips-mt76x8-360-p2-squashfs-sysupgrade.bin)
        echo "Firmware file: $FIRMWARE_FILE"
        echo "firmware_name=$FIRMWARE_FILE" >> $GITHUB_ENV
        
        # ÂàõÂª∫WebËÆøÈóÆ‰ø°ÊÅØÊñá‰ª∂
        LAN_IP="192.168.1.1"  # ÈªòËÆ§Ë∑ØÁî±Âô®IP
        echo "CUPS Web Interface: http://$LAN_IP:631" > web-access.txt
        echo "Username: ${{ github.event.inputs.web_admin_user}}" >> web-access.txt
        echo "Password: ${{ github.event.inputs.web_admin_pass}}" >> web-access.txt
        echo "Printer IP: ${{ github.event.inputs.printer_ip}}" >> web-access.txt
        echo "Note: CUPS will be installed on first boot" >> web-access.txt

    - name: üöÄ Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: 360P2-Printer-Firmware
        path: |
          openwrt/bin/targets/ramips/mt76x8/openwrt-ramips-mt76x8-360-p2-squashfs-sysupgrade.bin
          openwrt/bin/targets/ramips/mt76x8/web-access.txt
